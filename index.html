<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reliable OPC - Inventory Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .demo-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
            border-radius: 25px;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 25px;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 25px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px;
        }

        .table tbody tr:hover {
            background-color: #f1f3ff;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: 600;
            padding: 15px 25px;
            margin-right: 5px;
            border-radius: 10px 10px 0 0;
        }

        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }

        .history-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 10px 10px 0;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .login-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-header p {
            color: #666;
            margin: 0;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .input-group-text {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-right: none;
            color: #667eea;
        }

        .login-form .form-control {
            border-left: none;
            padding-left: 10px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }

        .login-form .form-control:focus {
            border-color: #667eea;
            box-shadow: none;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
        }

        .demo-credentials {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }

        .demo-credentials h6 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .credential-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        /* Brand Logo Styles */
        .brand-logo-section {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .brand-logo {
            width: 150px;
            height: 50px;
            object-fit: contain;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            background: white;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.8;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
            position: relative;
        }

        .brand-logo:hover {
            opacity: 1;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .brand-logo.selected {
            opacity: 1;
            border: 3px solid #667eea;
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.3),
                0 0 0 4px rgba(102, 126, 234, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transform: translateY(-5px) scale(1.08);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 50%, #e8ecff 100%);
            position: relative;
        }

        .brand-logo.selected::after {
            content: '✓';
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 
                0 4px 12px rgba(102, 126, 234, 0.4),
                0 0 0 3px rgba(255, 255, 255, 0.8),
                0 0 0 5px rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body>
    <!-- Demo Badge -->
    <div class="demo-badge">
        <i class="fas fa-flask"></i> DEMO VERSION
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-warehouse"></i>
                <h2>Reliable OPC</h2>
                <p>Inventory Management System</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" class="form-control" id="username" placeholder="Username" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" class="form-control" id="password" placeholder="Password" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-login">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            
            <div class="demo-credentials">
                <h6><i class="fas fa-info-circle"></i> Demo Credentials</h6>
                <div class="credential-item"><strong>Admin:</strong> admin / admin123</div>
                <div class="credential-item"><strong>Manager:</strong> manager / manager123</div>
                <div class="credential-item"><strong>User:</strong> user / user123</div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0"><i class="fas fa-warehouse"></i> Reliable OPC</h1>
                    <p class="mb-0">Inventory Management System</p>
                </div>
                <div class="user-info">
                    <div class="text-end me-3">
                        <div class="fw-bold" id="currentUser">User Name</div>
                        <small id="userRole">Role</small>
                        <div id="lastSavedIndicator" class="mt-1" style="font-size: 0.75rem;">
                            <i class="fas fa-exclamation-triangle text-warning"></i> No saved data found
                        </div>
                    </div>
                    <div class="btn-group me-3">
                        <button class="btn btn-success btn-sm" onclick="saveAllData()" title="Save All Data">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Data Management" id="dataManagementBtn" style="display: none;">
                            <i class="fas fa-database"></i>
                        </button>
                        <ul class="dropdown-menu" id="dataManagementMenu">
                            <li><a class="dropdown-item" href="#" onclick="exportAllData()" id="exportDataBtn">
                                <i class="fas fa-download"></i> Export Data
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="document.getElementById('importFile').click()" id="importDataBtn">
                                <i class="fas fa-upload"></i> Import Data
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> Clear All Data
                            </a></li>
                        </ul>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                    </div>
                    <div class="user-avatar" id="userAvatar">U</div>
                    <button class="btn logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="container-fluid p-4" id="contentArea">
            <!-- Inventory System Content -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Inventory Management</h3>
                <div>
                    <div class="btn-group me-2" id="exportButtons" style="display: none;">
                        <button class="btn btn-success" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn btn-info" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                    <div class="btn-group me-2" id="importButtons" style="display: none;">
                        <button class="btn btn-warning" onclick="downloadExcelTemplate()">
                            <i class="fas fa-download"></i> Excel Template
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('excelImportFile').click()">
                            <i class="fas fa-file-import"></i> Import Excel/CSV
                        </button>
                        <input type="file" id="excelImportFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importFromExcel(event)">
                    </div>
                    <button class="btn btn-primary" onclick="openAddItemModal()">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex gap-2" id="brandLogoSection">
                    </div>
                </div>
                
                <ul class="nav nav-tabs mb-0" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory-section" type="button" role="tab" onclick="showInventorySection()">
                            <i class="fas fa-warehouse"></i> Inventory
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="settings-tab-item" style="display: none;">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-section" type="button" role="tab" onclick="showSettingsSection()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content" id="mainTabContent">
                <!-- Inventory Section -->
                <div class="tab-pane fade show active" id="inventory-section" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <ul class="nav nav-tabs mb-0" id="inventoryTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-items-tab" data-bs-toggle="tab" data-bs-target="#all-items" type="button" role="tab" onclick="filterByType('')">
                                    <i class="fas fa-list"></i> All Items
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="machines-tab" data-bs-toggle="tab" data-bs-target="#machines" type="button" role="tab" onclick="filterByType('Machine')">
                                    <i class="fas fa-cogs"></i> Machines
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="disposables-tab" data-bs-toggle="tab" data-bs-target="#disposables" type="button" role="tab" onclick="filterByType('Disposable')">
                                    <i class="fas fa-box"></i> Disposables
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="instruments-tab" data-bs-toggle="tab" data-bs-target="#instruments" type="button" role="tab" onclick="filterByType('Instrument')">
                                    <i class="fas fa-tools"></i> Instruments
                                </button>
                            </li>
                        </ul>
                    </div>

                    <div class="search-container">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search items..." onkeyup="filterInventory()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="brandFilter" onchange="filterInventory(); updateBrandImage();">
                                    <option value="">All Brands</option>
                                    <option value="Brainlab">Brainlab</option>
                                    <option value="Inomed">Inomed</option>
                                    <option value="Medoc">Medoc</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="statusFilter" onchange="filterInventory()">
                                    <option value="">All Status</option>
                                    <option value="In Stock">In Stock</option>
                                    <option value="Low Stock">Low Stock</option>
                                    <option value="No Stock">No Stock</option>
                                    <option value="Pulled Out">Pulled Out</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                            <input type="hidden" id="typeFilter" value="">
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Type</th>
                                        <th>Airwaybill</th>
                                        <th>Item Name</th>
                                        <th>Lot/Serial</th>
                                        <th>Qty Balance</th>
                                        <th>Status</th>
                                        <th>Stored Place</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="tab-pane fade" id="settings-section" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user-cog"></i> User Management</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Name</th>
                                                    <th>Role</th>
                                                    <th>Permissions</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="usersTable">
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-primary mt-3" onclick="openAddUserModal()">
                                        <i class="fas fa-user-plus"></i> Add New User
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-palette"></i> System Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Company Name</label>
                                        <input type="text" class="form-control" id="companyName" value="Reliable OPC">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">System Theme</label>
                                        <select class="form-select" id="systemTheme">
                                            <option value="default">Default Blue</option>
                                            <option value="dark">Dark Mode</option>
                                            <option value="green">Green Theme</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Low Stock Threshold (%)</label>
                                        <input type="number" class="form-control" id="lowStockThreshold" value="20" min="1" max="50">
                                    </div>
                                    <button class="btn btn-success" onclick="saveSystemSettings()">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> System Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-primary mb-0" id="totalItems">0</h4>
                                            <small class="text-muted">Total Items</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success mb-0" id="inStockItems">0</h4>
                                            <small class="text-muted">In Stock</small>
                                        </div>
                                        <div class="col-6 mt-3">
                                            <h4 class="text-warning mb-0" id="lowStockItems">0</h4>
                                            <small class="text-muted">Low Stock</small>
                                        </div>
                                        <div class="col-6 mt-3">
                                            <h4 class="text-danger mb-0" id="outOfStockItems">0</h4>
                                            <small class="text-muted">Out of Stock</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-tools"></i> System Tools</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info" onclick="generateSystemReport()">
                                            <i class="fas fa-file-alt"></i> Generate System Report
                                        </button>
                                        <button class="btn btn-success" onclick="exportSystemData()">
                                            <i class="fas fa-download"></i> Export Complete Backup
                                        </button>
                                        <button class="btn btn-warning" onclick="resetToDefaults()">
                                            <i class="fas fa-undo"></i> Reset to Defaults
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                <!-- Settings Section -->
                <div class="tab-pane fade" id="settings-section" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-user-cog"></i> User Management</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Name</th>
                                                    <th>Role</th>
                                                    <th>Permissions</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="usersTable">
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-primary mt-3" onclick="openAddUserModal()">
                                        <i class="fas fa-user-plus"></i> Add New User
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-palette"></i> System Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Company Name</label>
                                        <input type="text" class="form-control" id="companyName" value="Reliable OPC">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">System Theme</label>
                                        <select class="form-select" id="systemTheme">
                                            <option value="default">Default Blue</option>
                                            <option value="dark">Dark Mode</option>
                                            <option value="green">Green Theme</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Low Stock Threshold (%)</label>
                                        <input type="number" class="form-control" id="lowStockThreshold" value="20" min="1" max="50">
                                    </div>
                                    <button class="btn btn-success" onclick="saveSystemSettings()">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> System Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-primary mb-0" id="totalItems">0</h4>
                                            <small class="text-muted">Total Items</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success mb-0" id="inStockItems">0</h4>
                                            <small class="text-muted">In Stock</small>
                                        </div>
                                        <div class="col-6 mt-3">
                                            <h4 class="text-warning mb-0" id="lowStockItems">0</h4>
                                            <small class="text-muted">Low Stock</small>
                                        </div>
                                        <div class="col-6 mt-3">
                                            <h4 class="text-danger mb-0" id="outOfStockItems">0</h4>
                                            <small class="text-muted">Out of Stock</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-tools"></i> System Tools</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info" onclick="generateSystemReport()">
                                            <i class="fas fa-file-alt"></i> Generate System Report
                                        </button>
                                        <button class="btn btn-success" onclick="exportSystemData()">
                                            <i class="fas fa-download"></i> Export Complete Backup
                                        </button>
                                        <button class="btn btn-warning" onclick="resetToDefaults()">
                                            <i class="fas fa-undo"></i> Reset to Defaults
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Item Type *</label>
                                    <select class="form-select" id="itemType" required>
                                        <option value="">Select Type</option>
                                        <option value="Machine">Machine</option>
                                        <option value="Disposable">Disposable</option>
                                        <option value="Instrument">Instrument</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand *</label>
                                    <select class="form-select" id="itemBrand" required>
                                        <option value="">Select Brand</option>
                                        <option value="Brainlab">Brainlab</option>
                                        <option value="Inomed">Inomed</option>
                                        <option value="Medoc">Medoc</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Item Name *</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lot/Serial Number *</label>
                                    <input type="text" class="form-control" id="lotSerial" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Reference Number</label>
                                    <input type="text" class="form-control" id="refNo">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Airwaybill Number</label>
                                    <input type="text" class="form-control" id="airwaybill">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quantity *</label>
                                    <input type="number" class="form-control" id="quantity" min="1" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Storage Location *</label>
                            <input type="text" class="form-control" id="storedPlace" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Stock Date *</label>
                            <input type="date" class="form-control" id="stockDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewItem()">
                        <i class="fas fa-save"></i> Save Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pull Out Modal -->
    <div class="modal fade" id="pullOutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-arrow-right"></i> Pull Out Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pullOutItemInfo" class="mb-3"></div>
                    <form id="pullOutForm">
                        <div class="mb-3">
                            <label class="form-label">Quantity to Pull Out *</label>
                            <input type="number" class="form-control" id="pullOutQuantity" min="1" required>
                            <div class="form-text">Available: <span id="availableQuantity">0</span></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks *</label>
                            <textarea class="form-control" id="pullOutRemarks" rows="3" required placeholder="Reason for pulling out this item..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmPullOut()">
                        <i class="fas fa-arrow-right"></i> Pull Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-history"></i> Item History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="historyContent">
                        <!-- History content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="newUserFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="">Select Role</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Manager">Manager</option>
                                <option value="User">User</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewUser()">
                        <i class="fas fa-save"></i> Add User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="originalUsername">
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="editUserFullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" id="editUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="">Select Role</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Manager">Manager</option>
                                <option value="User">User</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedUser()">
                        <i class="fas fa-save"></i> Update User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Permissions Modal -->
    <div class="modal fade" id="editPermissionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key"></i> Edit User Permissions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="fas fa-info-circle"></i> User Information</h6>
                            <div id="permissionUserInfo"></div>
                        </div>
                    </div>
                    
                    <form id="editPermissionsForm">
                        <input type="hidden" id="permissionUsername">
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allPermissions" onchange="toggleAllPermissions()">
                                <label class="form-check-label fw-bold text-success" for="allPermissions">
                                    <i class="fas fa-crown"></i> Administrator (All Permissions)
                                </label>
                                <div class="form-text">Grant full access to all system features</div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row" id="individualPermissions">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-eye"></i> Viewing Permissions</h6>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_view">
                                    <label class="form-check-label" for="perm_view">
                                        <strong>View Inventory</strong>
                                    </label>
                                    <div class="form-text">Can view all inventory items and their details</div>
                                </div>
                                
                                <h6 class="text-warning mb-3 mt-4"><i class="fas fa-edit"></i> Editing Permissions</h6>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_edit">
                                    <label class="form-check-label" for="perm_edit">
                                        <strong>Edit Items</strong>
                                    </label>
                                    <div class="form-text">Can add, edit, and modify inventory items</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_pullout">
                                    <label class="form-check-label" for="perm_pullout">
                                        <strong>Pull Out Items</strong>
                                    </label>
                                    <div class="form-text">Can pull out items from inventory</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_delete">
                                    <label class="form-check-label" for="perm_delete">
                                        <strong>Delete Items</strong>
                                    </label>
                                    <div class="form-text">Can permanently delete inventory items</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-download"></i> Data Management</h6>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_export">
                                    <label class="form-check-label" for="perm_export">
                                        <strong>Export Data</strong>
                                    </label>
                                    <div class="form-text">Can export inventory to CSV, Excel, and PDF</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_import">
                                    <label class="form-check-label" for="perm_import">
                                        <strong>Import Data</strong>
                                    </label>
                                    <div class="form-text">Can import inventory from Excel/CSV files</div>
                                </div>
                                
                                <h6 class="text-danger mb-3 mt-4"><i class="fas fa-cogs"></i> System Management</h6>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_users">
                                    <label class="form-check-label" for="perm_users">
                                        <strong>Manage Users</strong>
                                    </label>
                                    <div class="form-text">Can add, edit, and delete user accounts</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_settings">
                                    <label class="form-check-label" for="perm_settings">
                                        <strong>System Settings</strong>
                                    </label>
                                    <div class="form-text">Can modify system configuration and settings</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="perm_reports">
                                    <label class="form-check-label" for="perm_reports">
                                        <strong>Generate Reports</strong>
                                    </label>
                                    <div class="form-text">Can generate and export system reports</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> Permission Guidelines</h6>
                                <ul class="mb-0">
                                    <li><strong>View</strong> permission is required for all other permissions</li>
                                    <li><strong>Edit</strong> permission includes adding new items</li>
                                    <li><strong>System Management</strong> permissions should be granted carefully</li>
                                    <li><strong>Administrator</strong> role overrides all individual permissions</li>
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveUserPermissions()">
                        <i class="fas fa-save"></i> Save Permissions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editItemForm">
                        <input type="hidden" id="editItemId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Item Type *</label>
                                    <select class="form-select" id="editItemType" required>
                                        <option value="">Select Type</option>
                                        <option value="Machine">Machine</option>
                                        <option value="Disposable">Disposable</option>
                                        <option value="Instrument">Instrument</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand *</label>
                                    <select class="form-select" id="editItemBrand" required>
                                        <option value="">Select Brand</option>
                                        <option value="Brainlab">Brainlab</option>
                                        <option value="Inomed">Inomed</option>
                                        <option value="Medoc">Medoc</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Item Name *</label>
                            <input type="text" class="form-control" id="editItemName" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Lot/Serial Number *</label>
                                    <input type="text" class="form-control" id="editLotSerial" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Reference Number</label>
                                    <input type="text" class="form-control" id="editRefNo">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Airwaybill Number</label>
                                    <input type="text" class="form-control" id="editAirwaybill">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Total Quantity *</label>
                                    <input type="number" class="form-control" id="editQuantity" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Balance Quantity *</label>
                                    <input type="number" class="form-control" id="editQtyBalance" min="0" required>
                                    <div class="form-text">Current available quantity</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Storage Location *</label>
                            <input type="text" class="form-control" id="editStoredPlace" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Stock Date *</label>
                            <input type="date" class="form-control" id="editStockDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedItem()">
                        <i class="fas fa-save"></i> Update Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>


        // ===== JSONBin Config =====
const JSONBIN_API_KEY = "$2a$10$Rv2wnWadGLskU/x/QtjnquhNNEmTlWhIHJrCQKjuv88MclPTWKCzq"; // Replace with your API key
const JSONBIN_BIN_ID = "689e1b73ae596e708fca0f96";   // Replace with your Bin ID

    // ===== Existing Variables =====
    let currentUser = null;
    let inventoryData = [];  // start empty, will load from cloud
    let filteredData = [];
    let nextId = 1;
    
async function loadDataFromCloud() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { "X-Master-Key": JSONBIN_API_KEY }
        });
        const data = await res.json();
        if (data && data.record && data.record.inventoryData) {
            inventoryData = data.record.inventoryData;
            filteredData = [...inventoryData];
            loadInventoryTable();
            console.log("Data loaded from cloud");
        }
      } catch (err) {
        console.error("❌ Error loading from cloud:", err);
        // fallback to localStorage
        const local = localStorage.getItem("inventoryData");
        if (local) {
          inventoryData = JSON.parse(local);
          filteredData = [...inventoryData];
          loadInventoryTable();
          console.log("📦 Loaded from local backup");
        }
      }
    }

    async function saveDataToCloud() {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": JSONBIN_API_KEY
          },
          body: JSON.stringify({ inventoryData })
        });
        const data = await res.json();
        console.log("✅ Data saved to cloud", data);
        localStorage.setItem("inventoryData", JSON.stringify(inventoryData)); // backup
        showAlert("Changes saved to cloud!", "success");
      } catch (err) {
        console.error("❌ Error saving to cloud:", err);
        showAlert("Error saving to cloud! Check console.", "danger");
      }
    }

    // ===== Override Save Function =====
    function saveAllData() {
      saveDataToCloud();
    }



        // User credentials with permissions
        const users = {
            'admin': { 
                password: 'admin123', 
                name: 'Admin User', 
                role: 'Administrator', 
                permissions: ['all']
            },
            'manager': { 
                password: 'manager123', 
                name: 'Manager User', 
                role: 'Manager', 
                permissions: ['view', 'edit', 'pullout', 'delete', 'export', 'import']
            },
            'user': { 
                password: 'user123', 
                name: 'Regular User', 
                role: 'User', 
                permissions: ['view']
            }
        };

        // Brand configuration
        const brandConfig = {
            'Brainlab': {
                name: 'Brainlab',
                image: 'https://via.placeholder.com/150x50/2196F3/FFFFFF?text=Brainlab',
                icon: 'fas fa-brain',
                tooltip: 'Filter by Brainlab'
            },
            'Inomed': {
                name: 'Inomed',
                image: 'https://via.placeholder.com/150x50/9C27B0/FFFFFF?text=Inomed',
                icon: 'fas fa-heartbeat',
                tooltip: 'Filter by Inomed'
            },
            'Medoc': {
                name: 'Medoc',
                image: 'https://via.placeholder.com/150x50/4CAF50/FFFFFF?text=Medoc',
                icon: 'fas fa-heart',
                tooltip: 'Filter by Medoc'
            }
        };

        // Authentication functions
        function setupLoginForm() {
            setTimeout(() => {
                const loginForm = document.getElementById('loginForm');
                const loginButton = document.querySelector('.btn-login');
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleLogin();
                        return false;
                    });
                }
                
                if (loginButton) {
                    loginButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        handleLogin();
                        return false;
                    });
                }
                
                if (usernameInput) {
                    usernameInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleLogin();
                        }
                    });
                }
                
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleLogin();
                        }
                    });
                }
            }, 100);
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function handleLogin() {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            if (!usernameInput || !passwordInput) {
                alert('Login form error. Please refresh the page.');
                return;
            }
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                alert('Please enter both username and password!');
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    name: users[username].name,
                    role: users[username].role,
                    permissions: users[username].permissions
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                usernameInput.value = '';
                passwordInput.value = '';
                
                showMainApp();
                showAlert('Welcome back, ' + currentUser.name + '!', 'success');
                
            } else {
                alert('Invalid username or password! Try: admin/admin123');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Show/hide buttons based on permissions
            updateUIPermissions();
            
            generateBrandLogos();
            loadInventoryTable();
        }

        function updateUIPermissions() {
            // Export/Import buttons visibility
            const exportButtons = document.getElementById('exportButtons');
            const importButtons = document.getElementById('importButtons');
            const dataManagementBtn = document.getElementById('dataManagementBtn');
            
            // Hide export buttons for users without export permission
            if (hasPermission('export')) {
                exportButtons.style.display = 'inline-flex';
            } else {
                exportButtons.style.display = 'none';
            }
            
            // Hide import buttons for users without import permission
            if (hasPermission('import')) {
                importButtons.style.display = 'inline-flex';
            } else {
                importButtons.style.display = 'none';
            }
            
            // Show data management dropdown only if user has export or import permissions
            if (hasPermission('export') || hasPermission('import')) {
                dataManagementBtn.style.display = 'inline-block';
            } else {
                dataManagementBtn.style.display = 'none';
            }
            
            // Hide specific data management menu items
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importDataBtn = document.getElementById('importDataBtn');
            
            if (exportDataBtn && !hasPermission('export')) {
                exportDataBtn.style.display = 'none';
            }
            if (importDataBtn && !hasPermission('import')) {
                importDataBtn.style.display = 'none';
            }

            // Show/hide settings tab based on user management or settings permissions
            const settingsTabItem = document.getElementById('settings-tab-item');
            if (hasPermission('all') || hasPermission('users') || hasPermission('settings')) {
                settingsTabItem.style.display = 'block';
            } else {
                settingsTabItem.style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLoginScreen();
            showAlert('You have been logged out successfully.', 'info');
        }

        function hasPermission(permission) {
            if (!currentUser || !currentUser.permissions) return false;
            return currentUser.permissions.includes('all') || currentUser.permissions.includes(permission);
        }

        // Inventory functions
        function loadInventoryTable() {
            const tableBody = document.getElementById('inventoryTable');
            if (!tableBody) return;
            
            const dataToShow = hasActiveFilters() ? filteredData : inventoryData;
            
            let tableHTML = '';
            dataToShow.forEach((item, index) => {
                const statusBadge = getStatusBadge(item.status);
                tableHTML += 
                    '<tr>' +
                        '<td><strong>' + (index + 1) + '</strong></td>' +
                        '<td><span class="badge bg-secondary">' + item.type + '</span></td>' +
                        '<td><code>' + (item.airwaybill || 'N/A') + '</code></td>' +
                        '<td>' + item.itemName + '</td>' +
                        '<td><code>' + item.lotSerial + '</code></td>' +
                        '<td><span class="fw-bold ' + (item.qtyBalance > 0 ? 'text-success' : 'text-danger') + '">' + item.qtyBalance + '</span></td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td>' + item.storedPlace + '</td>' +
                        '<td>' +
                            '<div class="btn-group btn-group-sm">' +
                                (hasPermission('edit') ? '<button class="btn btn-outline-primary" onclick="editItem(' + item.id + ')" title="Edit">' +
                                    '<i class="fas fa-edit"></i>' +
                                '</button>' : '') +
                                (hasPermission('pullout') ? '<button class="btn btn-outline-warning" onclick="openPullOutModal(' + item.id + ')" title="Pull Out" ' + (item.qtyBalance <= 0 ? 'disabled' : '') + '>' +
                                    '<i class="fas fa-arrow-right"></i>' +
                                '</button>' : '') +
                                '<button class="btn btn-outline-info" onclick="viewHistory(' + item.id + ')" title="History">' +
                                    '<i class="fas fa-history"></i>' +
                                '</button>' +
                                (hasPermission('delete') ? '<button class="btn btn-outline-danger" onclick="deleteItem(' + item.id + ')" title="Delete">' +
                                    '<i class="fas fa-trash"></i>' +
                                '</button>' : '') +
                            '</div>' +
                        '</td>' +
                    '</tr>';
            });
            
            if (dataToShow.length === 0) {
                tableHTML = 
                    '<tr>' +
                        '<td colspan="9" class="text-center py-5">' +
                            '<i class="fas fa-search fa-3x text-muted mb-3"></i>' +
                            '<h5 class="text-muted">No items found</h5>' +
                            '<p class="text-muted">Try adjusting your search or filter criteria</p>' +
                        '</td>' +
                    '</tr>';
            }
            
            tableBody.innerHTML = tableHTML;
        }

        function filterInventory() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const brandFilter = document.getElementById('brandFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const typeFilter = document.getElementById('typeFilter')?.value || '';

            filteredData = inventoryData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.itemName.toLowerCase().includes(searchTerm) ||
                    item.lotSerial.toLowerCase().includes(searchTerm) ||
                    (item.refNo && item.refNo.toLowerCase().includes(searchTerm)) ||
                    item.storedPlace.toLowerCase().includes(searchTerm);
                
                const matchesBrand = !brandFilter || item.brand === brandFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                const matchesType = !typeFilter || item.type === typeFilter;
                
                return matchesSearch && matchesBrand && matchesStatus && matchesType;
            });

            updateBrandLogoHighlighting(brandFilter);
            loadInventoryTable();
        }

        function hasActiveFilters() {
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const brandFilter = document.getElementById('brandFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            
            return searchTerm.length > 0 || brandFilter.length > 0 || statusFilter.length > 0 || typeFilter.length > 0;
        }

        function filterByType(type) {
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) {
                typeFilter.value = type;
            }
            filterInventory();
        }

        function clearFilters() {
            const searchInput = document.getElementById('searchInput');
            const brandFilter = document.getElementById('brandFilter');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            
            if (searchInput) searchInput.value = '';
            if (brandFilter) brandFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            if (typeFilter) typeFilter.value = '';
            
            document.querySelectorAll('.brand-logo').forEach(logo => {
                logo.classList.remove('selected');
            });
            
            filteredData = [...inventoryData];
            loadInventoryTable();
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'In Stock':
                    return '<span class="badge bg-success">In Stock</span>';
                case 'Low Stock':
                    return '<span class="badge bg-warning">Low Stock</span>';
                case 'No Stock':
                    return '<span class="badge bg-danger">No Stock</span>';
                case 'Pulled Out':
                    return '<span class="badge bg-info">Pulled Out</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function generateBrandLogos() {
            const brandLogoSection = document.getElementById('brandLogoSection');
            if (!brandLogoSection) return;

            let logosHTML = '';

            ['Brainlab', 'Inomed', 'Medoc'].forEach(brandName => {
                const config = brandConfig[brandName];
                
                logosHTML += 
                    '<img src="' + config.image + '" ' +
                         'alt="' + config.name + '" ' +
                         'class="brand-logo" ' +
                         'onclick="setBrandFilter(\'' + brandName + '\')" ' +
                         'title="' + config.tooltip + '"' +
                         'onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'inline-block\';">' +
                    '<div class="brand-logo brand-icon-fallback" ' +
                         'onclick="setBrandFilter(\'' + brandName + '\')" ' +
                         'title="' + config.tooltip + '"' +
                         'style="display: none; background: #f8f9fa; border: 2px solid #dee2e6;">' +
                        '<i class="' + config.icon + ' fa-2x" style="color: #6c757d;"></i>' +
                    '</div>';
            });

            brandLogoSection.innerHTML = logosHTML;
        }

        function setBrandFilter(brandName) {
            const brandFilter = document.getElementById('brandFilter');
            if (brandFilter) {
                brandFilter.value = brandName;
                filterInventory();
                
                const brandLogos = document.querySelectorAll('.brand-logo');
                brandLogos.forEach(logo => logo.classList.remove('selected'));
                
                const clickedLogo = Array.from(brandLogos).find(logo => 
                    (logo.getAttribute('onclick') && logo.getAttribute('onclick').includes(brandName)) || 
                    (logo.getAttribute('title') && logo.getAttribute('title').includes(brandName))
                );
                if (clickedLogo) {
                    clickedLogo.classList.add('selected');
                }
            }
        }

        function updateBrandLogoHighlighting(selectedBrand) {
            document.querySelectorAll('.brand-logo').forEach(logo => {
                logo.classList.remove('selected');
            });
            
            if (selectedBrand) {
                const brandLogos = document.querySelectorAll('.brand-logo');
                brandLogos.forEach(logo => {
                    const logoTitle = logo.getAttribute('title');
                    if (logoTitle && logoTitle.includes(selectedBrand)) {
                        logo.classList.add('selected');
                    }
                });
            }
        }

        function updateBrandImage() {
            const brandFilter = document.getElementById('brandFilter');
            if (!brandFilter) return;
            
            const selectedBrand = brandFilter.value;
            updateBrandLogoHighlighting(selectedBrand);
        }

        // Modal functions
        function openAddItemModal() {
            if (!hasPermission('edit') && !hasPermission('all')) {
                showAlert('You do not have permission to add items!', 'danger');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stockDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        function saveNewItem() {
            const form = document.getElementById('addItemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newItem = {
                id: nextId++,
                type: document.getElementById('itemType').value,
                brand: document.getElementById('itemBrand').value,
                itemName: document.getElementById('itemName').value,
                lotSerial: document.getElementById('lotSerial').value,
                refNo: document.getElementById('refNo').value || '',
                airwaybill: document.getElementById('airwaybill').value || '',
                quantity: parseInt(document.getElementById('quantity').value),
                qtyBalance: parseInt(document.getElementById('quantity').value),
                storedPlace: document.getElementById('storedPlace').value,
                status: 'In Stock',
                stockDate: document.getElementById('stockDate').value,
                pullOutHistory: [],
                remarksHistory: [
                    { 
                        date: new Date().toISOString().split('T')[0], 
                        remark: 'Initial stock entry', 
                        user: currentUser.name 
                    }
                ]
            };

            inventoryData.unshift(newItem);
            filteredData = [...inventoryData];
            loadInventoryTable();

            saveAllData();

            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            
            showAlert('Item added successfully!', 'success');
        }

        function editItem(id) {
            if (!hasPermission('edit') && !hasPermission('all')) {
                showAlert('You do not have permission to edit items!', 'danger');
                return;
            }

            const item = inventoryData.find(item => item.id === id);
            if (!item) return;

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemType').value = item.type;
            document.getElementById('editItemBrand').value = item.brand;
            document.getElementById('editItemName').value = item.itemName;
            document.getElementById('editLotSerial').value = item.lotSerial;
            document.getElementById('editRefNo').value = item.refNo || '';
            document.getElementById('editAirwaybill').value = item.airwaybill || '';
            document.getElementById('editQuantity').value = item.quantity;
            document.getElementById('editQtyBalance').value = item.qtyBalance;
            document.getElementById('editStoredPlace').value = item.storedPlace;
            document.getElementById('editStockDate').value = item.stockDate;

            const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
            modal.show();
        }

        function saveEditedItem() {
            const form = document.getElementById('editItemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = parseInt(document.getElementById('editItemId').value);
            const itemIndex = inventoryData.findIndex(item => item.id === id);
            
            if (itemIndex === -1) return;

            const oldQuantity = inventoryData[itemIndex].quantity;
            const oldQtyBalance = inventoryData[itemIndex].qtyBalance;
            const newQuantity = parseInt(document.getElementById('editQuantity').value);
            const newQtyBalance = parseInt(document.getElementById('editQtyBalance').value);
            
            const qtyDifference = newQuantity - oldQuantity;
            const balanceDifference = newQtyBalance - oldQtyBalance;

            inventoryData[itemIndex] = {
                ...inventoryData[itemIndex],
                type: document.getElementById('editItemType').value,
                brand: document.getElementById('editItemBrand').value,
                itemName: document.getElementById('editItemName').value,
                lotSerial: document.getElementById('editLotSerial').value,
                refNo: document.getElementById('editRefNo').value || '',
                airwaybill: document.getElementById('editAirwaybill').value || '',
                quantity: newQuantity,
                qtyBalance: newQtyBalance,
                storedPlace: document.getElementById('editStoredPlace').value,
                stockDate: document.getElementById('editStockDate').value
            };

            const item = inventoryData[itemIndex];
            if (item.qtyBalance <= 0) {
                item.status = 'No Stock';
            } else if (item.qtyBalance < item.quantity * 0.2) {
                item.status = 'Low Stock';
            } else {
                item.status = 'In Stock';
            }

            let remarkText = 'Item updated by ' + currentUser.name;
            let changes = [];
            
            if (qtyDifference !== 0) {
                changes.push('Total quantity ' + (qtyDifference > 0 ? 'increased' : 'decreased') + ' by ' + Math.abs(qtyDifference));
            }
            if (balanceDifference !== 0) {
                changes.push('Balance ' + (balanceDifference > 0 ? 'increased' : 'decreased') + ' by ' + Math.abs(balanceDifference));
            }
            
            if (changes.length > 0) {
                remarkText += ' - ' + changes.join(', ') + ' (New balance: ' + item.qtyBalance + ')';
            }
            
            item.remarksHistory.unshift({
                date: new Date().toISOString().split('T')[0],
                remark: remarkText,
                user: currentUser.name
            });

            filteredData = [...inventoryData];
            loadInventoryTable();

            saveAllData();

            bootstrap.Modal.getInstance(document.getElementById('editItemModal')).hide();
            showAlert('Item updated successfully! Balance: ' + item.qtyBalance + ', Status: ' + item.status, 'success');
        }

        function deleteItem(id) {
            if (!hasPermission('delete') && !hasPermission('all')) {
                showAlert('You do not have permission to delete items!', 'danger');
                return;
            }

            const item = inventoryData.find(item => item.id === id);
            if (!item) return;

            if (confirm('Are you sure you want to delete "' + item.itemName + '"?\n\nThis action cannot be undone.')) {
                inventoryData = inventoryData.filter(item => item.id !== id);
                filteredData = [...inventoryData];
                loadInventoryTable();
                
                saveAllData();
                
                showAlert('Item deleted successfully!', 'success');
            }
        }

        function openPullOutModal(id) {
            if (!hasPermission('pullout') && !hasPermission('all')) {
                showAlert('You do not have permission to pull out items!', 'danger');
                return;
            }

            const item = inventoryData.find(item => item.id === id);
            if (!item || item.qtyBalance <= 0) return;

            document.getElementById('pullOutItemInfo').innerHTML = 
                '<div class="alert alert-info">' +
                    '<strong>' + item.itemName + '</strong><br>' +
                    '<small>Lot/Serial: ' + item.lotSerial + ' | Brand: ' + item.brand + '</small>' +
                '</div>';
            
            document.getElementById('availableQuantity').textContent = item.qtyBalance;
            document.getElementById('pullOutQuantity').max = item.qtyBalance;
            document.getElementById('pullOutQuantity').value = '';
            document.getElementById('pullOutRemarks').value = '';

            document.getElementById('pullOutModal').setAttribute('data-item-id', id);

            const modal = new bootstrap.Modal(document.getElementById('pullOutModal'));
            modal.show();
        }

        function confirmPullOut() {
            const form = document.getElementById('pullOutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const itemId = parseInt(document.getElementById('pullOutModal').getAttribute('data-item-id'));
            const quantity = parseInt(document.getElementById('pullOutQuantity').value);
            const remarks = document.getElementById('pullOutRemarks').value;

            const itemIndex = inventoryData.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;

            const item = inventoryData[itemIndex];
            
            if (quantity > item.qtyBalance) {
                showAlert('Cannot pull out more than available quantity!', 'danger');
                return;
            }

            item.qtyBalance -= quantity;

            if (item.qtyBalance <= 0) {
                item.status = 'Pulled Out';
            } else if (item.qtyBalance < item.quantity * 0.2) {
                item.status = 'Low Stock';
            }

            item.pullOutHistory.unshift({
                date: new Date().toISOString().split('T')[0],
                quantity: quantity,
                remark: remarks,
                user: currentUser.name
            });

            item.remarksHistory.unshift({
                date: new Date().toISOString().split('T')[0],
                remark: 'Pulled out ' + quantity + ' units: ' + remarks,
                user: currentUser.name
            });

            filteredData = [...inventoryData];
            loadInventoryTable();

            saveAllData();

            bootstrap.Modal.getInstance(document.getElementById('pullOutModal')).hide();
            showAlert('Successfully pulled out ' + quantity + ' units!', 'success');
        }

        function viewHistory(id) {
            const item = inventoryData.find(item => item.id === id);
            if (!item) return;

            let historyHTML = 
                '<div class="mb-4">' +
                    '<div class="card">' +
                        '<div class="card-header bg-primary text-white">' +
                            '<h5 class="mb-0"><i class="fas fa-info-circle"></i> ' + item.itemName + '</h5>' +
                        '</div>' +
                        '<div class="card-body">' +
                            '<div class="row">' +
                                '<div class="col-md-3">' +
                                    '<strong>Type:</strong> <span class="badge bg-secondary">' + item.type + '</span><br>' +
                                    '<strong>Brand:</strong> ' + item.brand + '<br>' +
                                    '<strong>Lot/Serial:</strong> <code>' + item.lotSerial + '</code>' +
                                '</div>' +
                                '<div class="col-md-3">' +
                                    '<strong>Original Qty:</strong> <span class="badge bg-info">' + item.quantity + '</span><br>' +
                                    '<strong>Current Balance:</strong> <span class="badge ' + (item.qtyBalance > 0 ? 'bg-success' : 'bg-danger') + '">' + item.qtyBalance + '</span><br>' +
                                    '<strong>Status:</strong> ' + getStatusBadge(item.status) +
                                '</div>' +
                                '<div class="col-md-3">' +
                                    '<strong>Stock Date:</strong> ' + item.stockDate + '<br>' +
                                    '<strong>Stored Place:</strong> ' + item.storedPlace + '<br>' +
                                    '<strong>Airwaybill:</strong> <code>' + (item.airwaybill || 'N/A') + '</code>' +
                                '</div>' +
                                '<div class="col-md-3 text-center">' +
                                    '<div class="mb-2">' +
                                        '<h4 class="text-primary mb-0">' + (item.quantity - item.qtyBalance) + '</h4>' +
                                        '<small class="text-muted">Total Pulled Out</small>' +
                                    '</div>' +
                                    '<div>' +
                                        '<h4 class="text-success mb-0">' + Math.round((item.qtyBalance / item.quantity) * 100) + '%</h4>' +
                                        '<small class="text-muted">Remaining</small>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';

            let allHistory = [];
            
            if (item.pullOutHistory && item.pullOutHistory.length > 0) {
                item.pullOutHistory.forEach(entry => {
                    allHistory.push({
                        date: entry.date,
                        type: 'pullout',
                        icon: 'fas fa-arrow-right',
                        color: 'danger',
                        title: 'Pulled Out ' + entry.quantity + ' units',
                        description: entry.remark,
                        user: entry.user
                    });
                });
            }
            
            if (item.remarksHistory && item.remarksHistory.length > 0) {
                item.remarksHistory.forEach(entry => {
                    allHistory.push({
                        date: entry.date,
                        type: 'activity',
                        icon: 'fas fa-edit',
                        color: 'info',
                        title: 'Activity',
                        description: entry.remark,
                        user: entry.user
                    });
                });
            }

            allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allHistory.length > 0) {
                historyHTML += 
                    '<div class="card">' +
                        '<div class="card-header">' +
                            '<h6 class="mb-0"><i class="fas fa-history"></i> History Timeline (' + allHistory.length + ' entries)</h6>' +
                        '</div>' +
                        '<div class="card-body">';
                
                allHistory.forEach((entry, index) => {
                    historyHTML += 
                        '<div class="d-flex mb-3 ' + (index === allHistory.length - 1 ? '' : 'border-bottom pb-3') + '">' +
                            '<div class="flex-shrink-0 me-3">' +
                                '<div class="bg-' + entry.color + ' text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">' +
                                    '<i class="' + entry.icon + '"></i>' +
                                '</div>' +
                            '</div>' +
                            '<div class="flex-grow-1">' +
                                '<div class="d-flex justify-content-between align-items-start">' +
                                    '<div>' +
                                        '<h6 class="mb-1">' + entry.title + '</h6>' +
                                        '<p class="mb-1 text-muted">' + entry.description + '</p>' +
                                        '<small class="text-muted">' +
                                            '<i class="fas fa-user"></i> ' + entry.user + ' • ' +
                                            '<i class="fas fa-calendar"></i> ' + entry.date +
                                        '</small>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                });
                
                historyHTML += 
                        '</div>' +
                    '</div>';
            } else {
                historyHTML += 
                    '<div class="card">' +
                        '<div class="card-body text-center py-5">' +
                            '<i class="fas fa-history fa-4x text-muted mb-3"></i>' +
                            '<h5 class="text-muted">No History Available</h5>' +
                            '<p class="text-muted">This item has no recorded activity yet.</p>' +
                        '</div>' +
                    '</div>';
            }

            document.getElementById('historyContent').innerHTML = historyHTML;

            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // Export functions
        function exportToCSV() {
            if (!hasPermission('export') && !hasPermission('all')) {
                showAlert('You do not have permission to export data!', 'danger');
                return;
            }

            const dataToExport = hasActiveFilters() ? filteredData : inventoryData;
            
            const headers = ['#', 'Type', 'Brand', 'Airwaybill', 'Item Name', 'Lot/Serial', 'Ref No', 'Quantity', 'Qty Balance', 'Status', 'Stock Date', 'Stored Place'];
            
            let csvContent = headers.join(',') + '\n';
            
            dataToExport.forEach((item, index) => {
                const row = [
                    index + 1,
                    '"' + item.type + '"',
                    '"' + item.brand + '"',
                    '"' + (item.airwaybill || 'N/A') + '"',
                    '"' + item.itemName + '"',
                    '"' + item.lotSerial + '"',
                    '"' + (item.refNo || 'N/A') + '"',
                    item.quantity,
                    item.qtyBalance,
                    '"' + item.status + '"',
                    '"' + item.stockDate + '"',
                    '"' + item.storedPlace + '"'
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            fallbackDownload(blob, 'inventory_export_' + new Date().toISOString().split('T')[0] + '.csv');
            showAlert('CSV file exported successfully!', 'success');
        }

        function exportToExcel() {
            if (!hasPermission('export') && !hasPermission('all')) {
                showAlert('You do not have permission to export data!', 'danger');
                return;
            }

            const dataToExport = hasActiveFilters() ? filteredData : inventoryData;
            
            let excelContent = 
                '<table border="1">' +
                    '<thead>' +
                        '<tr style="background-color: #667eea; color: white; font-weight: bold;">' +
                            '<th>#</th>' +
                            '<th>Type</th>' +
                            '<th>Brand</th>' +
                            '<th>Airwaybill</th>' +
                            '<th>Item Name</th>' +
                            '<th>Lot/Serial</th>' +
                            '<th>Ref No</th>' +
                            '<th>Quantity</th>' +
                            '<th>Qty Balance</th>' +
                            '<th>Status</th>' +
                            '<th>Stock Date</th>' +
                            '<th>Stored Place</th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody>';
            
            dataToExport.forEach((item, index) => {
                excelContent += 
                    '<tr>' +
                        '<td>' + (index + 1) + '</td>' +
                        '<td>' + item.type + '</td>' +
                        '<td>' + item.brand + '</td>' +
                        '<td>' + (item.airwaybill || 'N/A') + '</td>' +
                        '<td>' + item.itemName + '</td>' +
                        '<td>' + item.lotSerial + '</td>' +
                        '<td>' + (item.refNo || 'N/A') + '</td>' +
                        '<td>' + item.quantity + '</td>' +
                        '<td>' + item.qtyBalance + '</td>' +
                        '<td>' + item.status + '</td>' +
                        '<td>' + item.stockDate + '</td>' +
                        '<td>' + item.storedPlace + '</td>' +
                    '</tr>';
            });
            
            excelContent += 
                    '</tbody>' +
                '</table>';
            
            const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
            
            fallbackDownload(blob, 'inventory_export_' + new Date().toISOString().split('T')[0] + '.xls');
            showAlert('Excel file exported successfully!', 'success');
        }

        function exportToPDF() {
            if (!hasPermission('export') && !hasPermission('all')) {
                showAlert('You do not have permission to export data!', 'danger');
                return;
            }

            const dataToExport = hasActiveFilters() ? filteredData : inventoryData;
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showAlert('Please allow popups to generate PDF report.', 'warning');
                return;
            }
            
            const currentDate = new Date().toLocaleDateString();
            const currentTime = new Date().toLocaleTimeString();
            const userName = currentUser ? currentUser.name : 'Unknown User';
            const userRole = currentUser ? currentUser.role : 'Unknown Role';
            
            let pdfContent = '<!DOCTYPE html>' +
'<html>' +
'<head>' +
    '<title>Inventory Report</title>' +
    '<style>' +
        'body { font-family: Arial, sans-serif; margin: 20px; }' +
        '.header { text-align: center; margin-bottom: 30px; }' +
        '.company-info { text-align: center; margin-bottom: 20px; color: #666; }' +
        'table { width: 100%; border-collapse: collapse; margin-top: 20px; }' +
        'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }' +
        'th { background-color: #667eea; color: white; font-weight: bold; }' +
        'tr:nth-child(even) { background-color: #f9f9f9; }' +
        '.status-badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; }' +
        '.status-in-stock { background-color: #d4edda; color: #155724; }' +
        '.status-low-stock { background-color: #fff3cd; color: #856404; }' +
        '.status-no-stock { background-color: #f8d7da; color: #721c24; }' +
        '.status-pulled-out { background-color: #d1ecf1; color: #0c5460; }' +
        '.footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }' +
        '.save-instructions { ' +
            'position: fixed; ' +
            'top: 10px; ' +
            'right: 10px; ' +
            'background: #007bff; ' +
            'color: white; ' +
            'padding: 15px; ' +
            'border-radius: 8px; ' +
            'font-size: 14px; ' +
            'max-width: 300px; ' +
            'box-shadow: 0 4px 12px rgba(0,0,0,0.3);' +
            'z-index: 1000;' +
        '}' +
        '.save-instructions h4 { margin: 0 0 10px 0; font-size: 16px; }' +
        '.save-instructions ol { margin: 5px 0; padding-left: 20px; }' +
        '.save-instructions li { margin: 3px 0; }' +
        '@media print { ' +
            'body { margin: 0; } ' +
            '.no-print, .save-instructions { display: none; } ' +
        '}' +
    '</style>' +
'</head>' +
'<body>' +
    '<div class="save-instructions no-print">' +
        '<h4>Save to Downloads Folder:</h4>' +
        '<ol>' +
            '<li>Press <strong>Ctrl+P</strong> (or Cmd+P on Mac)</li>' +
            '<li>Select <strong>"Save as PDF"</strong></li>' +
            '<li>Choose <strong>Downloads</strong> folder</li>' +
            '<li>Click <strong>Save</strong></li>' +
        '</ol>' +
        '<small>This dialog will disappear when printing</small>' +
    '</div>' +
    
    '<div class="header">' +
        '<h1>Reliable OPC - Inventory Report</h1>' +
        '<div class="company-info">' +
            '<p>Generated on: ' + currentDate + ' at ' + currentTime + '</p>' +
            '<p>Total Items: ' + dataToExport.length + '</p>' +
        '</div>' +
    '</div>' +
    
    '<table>' +
        '<thead>' +
            '<tr>' +
                '<th>#</th>' +
                '<th>Type</th>' +
                '<th>Brand</th>' +
                '<th>Airwaybill</th>' +
                '<th>Item Name</th>' +
                '<th>Lot/Serial</th>' +
                '<th>Qty Balance</th>' +
                '<th>Status</th>' +
                '<th>Stored Place</th>' +
            '</tr>' +
        '</thead>' +
        '<tbody>';
            
            dataToExport.forEach((item, index) => {
                const statusClass = item.status.toLowerCase().replace(/\s+/g, '-');
                pdfContent += 
        '<tr>' +
            '<td>' + (index + 1) + '</td>' +
            '<td>' + item.type + '</td>' +
            '<td>' + item.brand + '</td>' +
            '<td>' + (item.airwaybill || 'N/A') + '</td>' +
            '<td>' + item.itemName + '</td>' +
            '<td>' + item.lotSerial + '</td>' +
            '<td>' + item.qtyBalance + '</td>' +
            '<td><span class="status-badge status-' + statusClass + '">' + item.status + '</span></td>' +
            '<td>' + item.storedPlace + '</td>' +
        '</tr>';
            });
            
            pdfContent += 
        '</tbody>' +
    '</table>' +
    
    '<div class="footer">' +
        '<p>This report was generated by Reliable OPC Inventory Management System</p>' +
        '<p>Report generated by: ' + userName + ' (' + userRole + ')</p>' +
    '</div>' +
    
    '<script>' +
        'setTimeout(function() { window.print(); }, 1000);' +
        'window.addEventListener("afterprint", function() {' +
            'setTimeout(function() { window.close(); }, 2000);' +
        '});' +
    '<\/script>' +
'</body>' +
'</html>';
            
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            
            showAlert('PDF report opened! Use Ctrl+P (or Cmd+P) to save as PDF to your Downloads folder.', 'info');
        }

        function downloadExcelTemplate() {
            const headers = ['Type', 'Brand', 'Item Name', 'Lot/Serial Number', 'Reference Number', 'Airwaybill Number', 'Quantity', 'Storage Location', 'Stock Date'];
            
            const templateData = [
                ['Machine', 'Brainlab', 'Sample X-Ray Machine', 'XR-2024-001', 'REF-XR-001', 'AWB-12345', '1', 'Warehouse A - Section 1', '2024-01-15'],
                ['Disposable', 'Medoc', 'Surgical Gloves Box', 'SG-2024-002', 'REF-SG-002', 'AWB-67890', '50', 'Storage Room B - Shelf 1', '2024-01-15'],
                ['Instrument', 'Inomed', 'Digital Thermometer', 'DT-2024-003', 'REF-DT-003', 'AWB-11111', '10', 'Medical Supply Room A', '2024-01-15']
            ];

            let csvContent = headers.map(header => '"' + header + '"').join(',') + '\n';
            
            templateData.forEach(row => {
                csvContent += row.map(cell => '"' + cell + '"').join(',') + '\n';
            });

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            fallbackDownload(blob, 'inventory_template_' + new Date().toISOString().split('T')[0] + '.csv');
            showAlert('CSV template downloaded! Open in Excel, edit your data, and save as CSV or Excel format to import back.', 'success');
        }

        function importFromExcel(event) {
            if (!hasPermission('edit') && !hasPermission('all')) {
                showAlert('You do not have permission to import items!', 'danger');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.csv')) {
                showAlert('Please select a valid Excel file (.xlsx, .xls) or CSV file.', 'warning');
                event.target.value = '';
                return;
            }

            showAlert('Reading file... Please wait.', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = parseCSVData(e.target.result);
                    
                    if (workbook && workbook.length > 0) {
                        showImportPreview(workbook);
                    } else {
                        showAlert('No valid data found in the file. Please ensure your file has headers and data rows.', 'warning');
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    showAlert('Error reading file. Please try saving as CSV format.', 'danger');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function parseCSVData(data) {
            try {
                if (data.charCodeAt(0) === 0xFEFF) {
                    data = data.slice(1);
                }
                
                const lines = data.split('\n').filter(line => line.trim().length > 0);
                
                if (lines.length < 2) return [];
                
                let headers = lines[0].split(',').map(h => h.trim().replace(/^["']|["']$/g, ''));
                
                const items = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    let values = line.split(',').map(v => v.trim().replace(/^["']|["']$/g, ''));
                    
                    if (values.length < 3) continue;

                    const item = {};
                    headers.forEach((header, index) => {
                        if (header && values[index] !== undefined) {
                            item[header] = values[index];
                        }
                    });

                    const normalizedItem = normalizeItemHeaders(item);

                    if (normalizedItem['Item Name'] && normalizedItem['Type'] && normalizedItem['Brand']) {
                        items.push(normalizedItem);
                    }
                }

                return items;
            } catch (error) {
                console.error('Error parsing CSV data:', error);
                return [];
            }
        }

        function normalizeItemHeaders(item) {
            const normalized = {};
            
            const headerMappings = {
                'type': 'Type',
                'item type': 'Type',
                'category': 'Type',
                
                'brand': 'Brand',
                'manufacturer': 'Brand',
                
                'item name': 'Item Name',
                'name': 'Item Name',
                'product name': 'Item Name',
                
                'lot/serial number': 'Lot/Serial Number',
                'lot number': 'Lot/Serial Number',
                'serial number': 'Lot/Serial Number',
                'lot': 'Lot/Serial Number',
                'serial': 'Lot/Serial Number',
                
                'reference number': 'Reference Number',
                'ref number': 'Reference Number',
                'ref no': 'Reference Number',
                'reference': 'Reference Number',
                
                'airwaybill number': 'Airwaybill Number',
                'airwaybill': 'Airwaybill Number',
                'awb': 'Airwaybill Number',
                
                'quantity': 'Quantity',
                'qty': 'Quantity',
                'amount': 'Quantity',
                
                'storage location': 'Storage Location',
                'location': 'Storage Location',
                'stored place': 'Storage Location',
                'warehouse': 'Storage Location',
                
                'stock date': 'Stock Date',
                'date': 'Stock Date',
                'received date': 'Stock Date'
            };
            
            Object.keys(item).forEach(key => {
                if (!key || key.trim() === '') return;
                
                const cleanKey = key.trim().toLowerCase();
                const normalizedKey = headerMappings[cleanKey] || key.trim();
                
                const value = item[key];
                if (value !== undefined && value !== null && value.toString().trim() !== '') {
                    normalized[normalizedKey] = value.toString().trim();
                }
            });
            
            if (!normalized['Quantity'] && normalized['Quantity'] !== '0') {
                normalized['Quantity'] = '1';
            }
            
            if (!normalized['Stock Date']) {
                normalized['Stock Date'] = new Date().toISOString().split('T')[0];
            }
            
            return normalized;
        }

        function showImportPreview(importData) {
            const validItems = [];
            const invalidItems = [];

            importData.forEach((item, index) => {
                const validation = validateImportItem(item, index + 2);
                if (validation.isValid) {
                    validItems.push({
                        ...item,
                        rowNumber: index + 2
                    });
                } else {
                    invalidItems.push({
                        ...item,
                        rowNumber: index + 2,
                        errors: validation.errors
                    });
                }
            });

            let previewHTML = 
                '<div class="mb-4">' +
                    '<div class="alert alert-info">' +
                        '<h6><i class="fas fa-info-circle"></i> Import Preview</h6>' +
                        '<p class="mb-0">' +
                            'Found <strong>' + importData.length + '</strong> items in file<br>' +
                            '<span class="text-success"><strong>' + validItems.length + '</strong> valid items</span> | ' +
                            '<span class="text-danger"><strong>' + invalidItems.length + '</strong> invalid items</span>' +
                        '</p>' +
                    '</div>' +
                '</div>';

            if (validItems.length > 0) {
                previewHTML += 
                    '<div class="card mb-3">' +
                        '<div class="card-header bg-success text-white">' +
                            '<h6 class="mb-0"><i class="fas fa-check-circle"></i> Valid Items (' + validItems.length + ')</h6>' +
                        '</div>' +
                        '<div class="card-body">' +
                            '<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">' +
                                '<table class="table table-sm table-hover">' +
                                    '<thead class="table-dark sticky-top">' +
                                        '<tr>' +
                                            '<th>Row</th>' +
                                            '<th>Type</th>' +
                                            '<th>Brand</th>' +
                                            '<th>Item Name</th>' +
                                            '<th>Lot/Serial</th>' +
                                            '<th>Quantity</th>' +
                                            '<th>Storage Location</th>' +
                                        '</tr>' +
                                    '</thead>' +
                                    '<tbody>';
                                        
                validItems.forEach(item => {
                    previewHTML += 
                        '<tr>' +
                            '<td><span class="badge bg-secondary">' + item.rowNumber + '</span></td>' +
                            '<td><span class="badge bg-primary">' + item['Type'] + '</span></td>' +
                            '<td>' + item['Brand'] + '</td>' +
                            '<td>' + item['Item Name'] + '</td>' +
                            '<td><code>' + item['Lot/Serial Number'] + '</code></td>' +
                            '<td><span class="badge bg-info">' + (item['Quantity'] || 1) + '</span></td>' +
                            '<td>' + item['Storage Location'] + '</td>' +
                        '</tr>';
                });
                                        
                previewHTML += 
                                    '</tbody>' +
                                '</table>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }

            if (invalidItems.length > 0) {
                previewHTML += 
                    '<div class="card mb-3">' +
                        '<div class="card-header bg-danger text-white">' +
                            '<h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Invalid Items (' + invalidItems.length + ')</h6>' +
                        '</div>' +
                        '<div class="card-body">' +
                            '<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">' +
                                '<table class="table table-sm table-hover">' +
                                    '<thead class="table-dark sticky-top">' +
                                        '<tr>' +
                                            '<th>Row</th>' +
                                            '<th>Item Name</th>' +
                                            '<th>Errors</th>' +
                                        '</tr>' +
                                    '</thead>' +
                                    '<tbody>';
                                        
                invalidItems.forEach(item => {
                    previewHTML += 
                        '<tr>' +
                            '<td><span class="badge bg-secondary">' + item.rowNumber + '</span></td>' +
                            '<td>' + (item['Item Name'] || '<em>Missing</em>') + '</td>' +
                            '<td>';
                    
                    item.errors.forEach(error => {
                        previewHTML += '<span class="badge bg-danger me-1">' + error + '</span>';
                    });
                    
                    previewHTML += 
                            '</td>' +
                        '</tr>';
                });
                                        
                previewHTML += 
                                    '</tbody>' +
                                '</table>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }

            const modalHTML = 
                '<div class="modal fade" id="importPreviewModal" tabindex="-1">' +
                    '<div class="modal-dialog modal-xl">' +
                        '<div class="modal-content">' +
                            '<div class="modal-header">' +
                                '<h5 class="modal-title"><i class="fas fa-file-import"></i> Import Preview</h5>' +
                                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                            '</div>' +
                            '<div class="modal-body">' +
                                previewHTML +
                            '</div>' +
                            '<div class="modal-footer">' +
                                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
                                (validItems.length > 0 ? 
                                    '<button type="button" class="btn btn-success" id="confirmImportBtn">' +
                                        '<i class="fas fa-check"></i> Import ' + validItems.length + ' Valid Items' +
                                    '</button>' : '') +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';

            const existingModal = document.getElementById('importPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = new bootstrap.Modal(document.getElementById('importPreviewModal'));
            modal.show();

            // Add event listener for the import button
            const confirmBtn = document.getElementById('confirmImportBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    confirmExcelImport(validItems);
                });
            }

            document.getElementById('importPreviewModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function validateImportItem(item, rowNumber) {
            const errors = [];
            
            if (!item['Item Name'] || item['Item Name'].trim() === '') {
                errors.push('Item Name required');
            }
            
            if (!item['Type'] || !['Machine', 'Disposable', 'Instrument'].includes(item['Type'])) {
                errors.push('Invalid Type');
            }
            
            if (!item['Brand'] || !['Brainlab', 'Inomed', 'Medoc'].includes(item['Brand'])) {
                errors.push('Invalid Brand');
            }
            
            if (!item['Lot/Serial Number'] || item['Lot/Serial Number'].trim() === '') {
                errors.push('Lot/Serial required');
            }
            
            if (!item['Storage Location'] || item['Storage Location'].trim() === '') {
                errors.push('Storage Location required');
            }
            
            const quantity = parseInt(item['Quantity']);
            if (isNaN(quantity) || quantity < 1) {
                errors.push('Invalid Quantity');
            }
            
            const existingItem = inventoryData.find(existing => 
                existing.lotSerial.toLowerCase() === item['Lot/Serial Number'].toLowerCase()
            );
            if (existingItem) {
                errors.push('Duplicate Lot/Serial');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        function confirmExcelImport(validItems) {
            try {
                let importedCount = 0;
                const today = new Date().toISOString().split('T')[0];
                
                validItems.forEach(item => {
                    const newItem = {
                        id: nextId++,
                        type: item['Type'],
                        brand: item['Brand'],
                        itemName: item['Item Name'],
                        lotSerial: item['Lot/Serial Number'],
                        refNo: item['Reference Number'] || '',
                        airwaybill: item['Airwaybill Number'] || '',
                        quantity: parseInt(item['Quantity']) || 1,
                        qtyBalance: parseInt(item['Quantity']) || 1,
                        storedPlace: item['Storage Location'],
                        status: 'In Stock',
                        stockDate: item['Stock Date'] || today,
                        pullOutHistory: [],
                        remarksHistory: [
                            { 
                                date: today, 
                                remark: 'Imported from Excel (Row ' + item.rowNumber + ')', 
                                user: currentUser.name 
                            }
                        ]
                    };
                    
                    inventoryData.unshift(newItem);
                    importedCount++;
                });
                
                filteredData = [...inventoryData];
                loadInventoryTable();
                
                saveAllData();
                
                bootstrap.Modal.getInstance(document.getElementById('importPreviewModal')).hide();
                
                showAlert('Successfully imported ' + importedCount + ' items from Excel!', 'success');
                
            } catch (error) {
                console.error('Error importing items:', error);
                showAlert('Error importing items. Please try again.', 'danger');
            }
        }

        function fallbackDownload(blob, filename) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Save/Load functions
function saveAllData() {
    saveDataToCloud();
}


        function loadAllData() {
            try {
                const savedData = localStorage.getItem('reliableOPCData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.inventoryData) inventoryData = data.inventoryData;
                    if (data.nextId) nextId = data.nextId;
                    
                    filteredData = [...inventoryData];
                    
                    const indicator = document.getElementById('lastSavedIndicator');
                    if (indicator && data.lastSaved) {
                        const lastSaved = new Date(data.lastSaved);
                        indicator.innerHTML = '<i class="fas fa-check-circle text-success"></i> Last saved: ' + lastSaved.toLocaleString();
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            return false;
        }

        function exportAllData() {
            try {
                const dataToExport = {
                    inventoryData: inventoryData,
                    nextId: nextId,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                fallbackDownload(blob, 'reliable_opc_backup_' + new Date().toISOString().split('T')[0] + '.json');
                
                showAlert('Data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Error exporting data. Please try again.', 'danger');
            }
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.inventoryData) {
                        inventoryData = importedData.inventoryData;
                        filteredData = [...inventoryData];
                    }
                    if (importedData.nextId) nextId = importedData.nextId;
                    
                    saveAllData();
                    
                    if (document.getElementById('inventoryTable')) {
                        loadInventoryTable();
                    }
                    
                    showAlert('Data imported successfully!', 'success');
                } catch (error) {
                    console.error('Error importing data:', error);
                    showAlert('Error importing data. Please check the file format.', 'danger');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data?\n\nThis action cannot be undone and will remove all inventory items and history.')) {
                localStorage.removeItem('reliableOPCData');
                
                inventoryData = [];
                filteredData = [];
                nextId = 1;
                
                if (document.getElementById('inventoryTable')) {
                    loadInventoryTable();
                }
                
                const indicator = document.getElementById('lastSavedIndicator');
                if (indicator) {
                    indicator.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> No saved data found';
                }
                
                showAlert('All data cleared successfully!', 'info');
            }
        }

        // Alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = 
                '<i class="fas fa-' + (type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle') + '"></i> ' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Settings functions
        function showInventorySection() {
            // This function is called when inventory tab is clicked
            // Bootstrap handles the tab switching automatically
        }

        function showSettingsSection() {
            loadUsersTable();
            updateSystemStatistics();
        }

        function loadUsersTable() {
            const tableBody = document.getElementById('usersTable');
            if (!tableBody) return;

            let tableHTML = '';
            Object.keys(users).forEach(username => {
                const user = users[username];
                const permissionsList = user.permissions.includes('all') ? 
                    '<span class="badge bg-success">All Permissions</span>' :
                    user.permissions.map(p => '<span class="badge bg-info me-1">' + p + '</span>').join('');

                tableHTML += 
                    '<tr>' +
                        '<td><strong>' + username + '</strong></td>' +
                        '<td>' + user.name + '</td>' +
                        '<td><span class="badge bg-primary">' + user.role + '</span></td>' +
                        '<td>' + permissionsList + '</td>' +
                        '<td>' +
                            '<div class="btn-group btn-group-sm">' +
                                '<button class="btn btn-outline-primary" onclick="editUser(\'' + username + '\')" title="Edit User">' +
                                    '<i class="fas fa-edit"></i>' +
                                '</button>' +
                                '<button class="btn btn-outline-success" onclick="editUserPermissions(\'' + username + '\')" title="Edit Permissions">' +
                                    '<i class="fas fa-key"></i>' +
                                '</button>' +
                                (username !== 'admin' ? 
                                    '<button class="btn btn-outline-danger" onclick="deleteUser(\'' + username + '\')" title="Delete">' +
                                        '<i class="fas fa-trash"></i>' +
                                    '</button>' : '') +
                            '</div>' +
                        '</td>' +
                    '</tr>';
            });

            tableBody.innerHTML = tableHTML;
        }

        function updateSystemStatistics() {
            const totalItems = inventoryData.length;
            const inStockItems = inventoryData.filter(item => item.status === 'In Stock').length;
            const lowStockItems = inventoryData.filter(item => item.status === 'Low Stock').length;
            const outOfStockItems = inventoryData.filter(item => item.status === 'No Stock' || item.status === 'Pulled Out').length;

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('inStockItems').textContent = inStockItems;
            document.getElementById('lowStockItems').textContent = lowStockItems;
            document.getElementById('outOfStockItems').textContent = outOfStockItems;
        }

        function openAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        function saveNewUser() {
            const form = document.getElementById('addUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const username = document.getElementById('newUsername').value.toLowerCase();
            const fullName = document.getElementById('newUserFullName').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (users[username]) {
                showAlert('Username already exists!', 'danger');
                return;
            }

            let permissions = [];
            switch(role) {
                case 'Administrator':
                    permissions = ['all'];
                    break;
                case 'Manager':
                    permissions = ['view', 'edit', 'pullout', 'delete'];
                    break;
                case 'User':
                    permissions = ['view'];
                    break;
            }

            users[username] = {
                password: password,
                name: fullName,
                role: role,
                permissions: permissions
            };

            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            loadUsersTable();
            showAlert('User added successfully!', 'success');
        }

        function editUser(username) {
            const user = users[username];
            if (!user) return;

            document.getElementById('editUsername').value = username;
            document.getElementById('editUserFullName').value = user.name;
            document.getElementById('editUserPassword').value = user.password;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('originalUsername').value = username;

            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        function saveEditedUser() {
            const form = document.getElementById('editUserForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const originalUsername = document.getElementById('originalUsername').value;
            const newUsername = document.getElementById('editUsername').value.toLowerCase();
            const fullName = document.getElementById('editUserFullName').value;
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;

            // Check if username changed and new username already exists
            if (originalUsername !== newUsername && users[newUsername]) {
                showAlert('Username already exists!', 'danger');
                return;
            }

            let permissions = [];
            switch(role) {
                case 'Administrator':
                    permissions = ['all'];
                    break;
                case 'Manager':
                    permissions = ['view', 'edit', 'pullout', 'delete', 'export', 'import'];
                    break;
                case 'User':
                    permissions = ['view'];
                    break;
            }

            // If username changed, delete old entry
            if (originalUsername !== newUsername) {
                delete users[originalUsername];
            }

            users[newUsername] = {
                password: password,
                name: fullName,
                role: role,
                permissions: permissions
            };

            // Update current user if editing self
            if (currentUser && currentUser.username === originalUsername) {
                currentUser.username = newUsername;
                currentUser.name = fullName;
                currentUser.role = role;
                currentUser.permissions = permissions;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update UI
                document.getElementById('currentUser').textContent = fullName;
                document.getElementById('userRole').textContent = role;
                document.getElementById('userAvatar').textContent = fullName.charAt(0).toUpperCase();
                updateUIPermissions();
            }

            saveUsersData();
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            loadUsersTable();
            showAlert('User updated successfully!', 'success');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                showAlert('Cannot delete admin user!', 'danger');
                return;
            }

            if (currentUser && currentUser.username === username) {
                showAlert('Cannot delete your own account!', 'danger');
                return;
            }

            const user = users[username];
            if (confirm('Are you sure you want to delete user "' + user.name + '" (' + username + ')?\n\nThis action cannot be undone.')) {
                delete users[username];
                saveUsersData();
                loadUsersTable();
                showAlert('User "' + user.name + '" deleted successfully!', 'success');
            }
        }

        function saveSystemSettings() {
            const companyName = document.getElementById('companyName').value;
            const theme = document.getElementById('systemTheme').value;
            const threshold = document.getElementById('lowStockThreshold').value;

            if (!companyName.trim()) {
                showAlert('Company name cannot be empty!', 'danger');
                return;
            }

            if (threshold < 1 || threshold > 50) {
                showAlert('Low stock threshold must be between 1% and 50%!', 'danger');
                return;
            }

            const settings = {
                companyName: companyName.trim(),
                theme: theme,
                lowStockThreshold: parseInt(threshold)
            };

            localStorage.setItem('systemSettings', JSON.stringify(settings));
            
            // Apply theme immediately
            applyTheme(theme);
            
            // Update company name in header
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                headerTitle.innerHTML = '<i class="fas fa-warehouse"></i> ' + companyName;
            }

            // Update low stock statuses based on new threshold
            updateStockStatuses(parseInt(threshold));
            
            showAlert('Settings saved and applied successfully!', 'success');
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            
            switch(theme) {
                case 'dark':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)');
                    root.style.setProperty('--secondary-gradient', 'linear-gradient(135deg, #34495e 0%, #2c3e50 100%)');
                    document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
                    break;
                case 'green':
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)');
                    root.style.setProperty('--secondary-gradient', 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)');
                    document.body.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                    break;
                default: // default blue
                    root.style.setProperty('--primary-gradient', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                    root.style.setProperty('--secondary-gradient', 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)');
                    document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    break;
            }
        }

        function updateStockStatuses(threshold) {
            let updatedCount = 0;
            
            inventoryData.forEach(item => {
                const oldStatus = item.status;
                const stockPercentage = (item.qtyBalance / item.quantity) * 100;
                
                if (item.qtyBalance <= 0) {
                    item.status = item.status === 'Pulled Out' ? 'Pulled Out' : 'No Stock';
                } else if (stockPercentage <= threshold) {
                    item.status = 'Low Stock';
                } else {
                    item.status = 'In Stock';
                }
                
                if (oldStatus !== item.status) {
                    updatedCount++;
                    item.remarksHistory.unshift({
                        date: new Date().toISOString().split('T')[0],
                        remark: 'Status updated from "' + oldStatus + '" to "' + item.status + '" due to threshold change (' + threshold + '%)',
                        user: currentUser.name
                    });
                }
            });
            
            if (updatedCount > 0) {
                filteredData = [...inventoryData];
                loadInventoryTable();
                updateSystemStatistics();
                saveAllData();
                showAlert(updatedCount + ' items had their status updated based on new threshold.', 'info');
            }
        }

        function loadSystemSettings() {
            try {
                const savedSettings = localStorage.getItem('systemSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    if (settings.companyName) {
                        document.getElementById('companyName').value = settings.companyName;
                        const headerTitle = document.querySelector('.header h1');
                        if (headerTitle) {
                            headerTitle.innerHTML = '<i class="fas fa-warehouse"></i> ' + settings.companyName;
                        }
                    }
                    
                    if (settings.theme) {
                        document.getElementById('systemTheme').value = settings.theme;
                        applyTheme(settings.theme);
                    }
                    
                    if (settings.lowStockThreshold) {
                        document.getElementById('lowStockThreshold').value = settings.lowStockThreshold;
                    }
                }
            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        function saveUsersData() {
            try {
                localStorage.setItem('systemUsers', JSON.stringify(users));
            } catch (error) {
                console.error('Error saving users data:', error);
                showAlert('Error saving user data!', 'danger');
            }
        }

        function loadUsersData() {
            try {
                const savedUsers = localStorage.getItem('systemUsers');
                if (savedUsers) {
                    const loadedUsers = JSON.parse(savedUsers);
                    // Merge with default users, keeping any new users
                    Object.assign(users, loadedUsers);
                }
            } catch (error) {
                console.error('Error loading users data:', error);
            }
        }

        function editUserPermissions(username) {
            const user = users[username];
            if (!user) return;

            // Set user info
            document.getElementById('permissionUsername').value = username;
            document.getElementById('permissionUserInfo').innerHTML = 
                '<strong>Username:</strong> ' + username + '<br>' +
                '<strong>Name:</strong> ' + user.name + '<br>' +
                '<strong>Role:</strong> <span class="badge bg-primary">' + user.role + '</span>';

            // Reset all checkboxes
            const allCheckboxes = document.querySelectorAll('#editPermissionsForm input[type="checkbox"]');
            allCheckboxes.forEach(checkbox => checkbox.checked = false);

            // Check if user has all permissions
            if (user.permissions.includes('all')) {
                document.getElementById('allPermissions').checked = true;
                toggleAllPermissions();
            } else {
                // Check individual permissions
                const permissionMap = {
                    'view': 'perm_view',
                    'edit': 'perm_edit',
                    'pullout': 'perm_pullout',
                    'delete': 'perm_delete',
                    'export': 'perm_export',
                    'import': 'perm_import',
                    'users': 'perm_users',
                    'settings': 'perm_settings',
                    'reports': 'perm_reports'
                };

                user.permissions.forEach(permission => {
                    const checkboxId = permissionMap[permission];
                    if (checkboxId) {
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }

            const modal = new bootstrap.Modal(document.getElementById('editPermissionsModal'));
            modal.show();
        }

        function toggleAllPermissions() {
            const allPermissionsCheckbox = document.getElementById('allPermissions');
            const individualCheckboxes = document.querySelectorAll('#individualPermissions input[type="checkbox"]');
            const individualPermissionsDiv = document.getElementById('individualPermissions');

            if (allPermissionsCheckbox.checked) {
                // Disable and check all individual permissions
                individualCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    checkbox.disabled = true;
                });
                individualPermissionsDiv.style.opacity = '0.5';
            } else {
                // Enable all individual permissions
                individualCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
                individualPermissionsDiv.style.opacity = '1';
            }
        }

        function saveUserPermissions() {
            const username = document.getElementById('permissionUsername').value;
            const user = users[username];
            if (!user) return;

            const allPermissionsCheckbox = document.getElementById('allPermissions');
            
            if (allPermissionsCheckbox.checked) {
                // Grant all permissions
                user.permissions = ['all'];
            } else {
                // Collect individual permissions
                const permissions = [];
                const permissionCheckboxes = {
                    'perm_view': 'view',
                    'perm_edit': 'edit',
                    'perm_pullout': 'pullout',
                    'perm_delete': 'delete',
                    'perm_export': 'export',
                    'perm_import': 'import',
                    'perm_users': 'users',
                    'perm_settings': 'settings',
                    'perm_reports': 'reports'
                };

                Object.keys(permissionCheckboxes).forEach(checkboxId => {
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox && checkbox.checked) {
                        permissions.push(permissionCheckboxes[checkboxId]);
                    }
                });

                // Ensure view permission is always included if any other permission is selected
                if (permissions.length > 0 && !permissions.includes('view')) {
                    permissions.unshift('view');
                }

                user.permissions = permissions;
            }

            // Update current user if editing self
            if (currentUser && currentUser.username === username) {
                currentUser.permissions = user.permissions;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUIPermissions();
            }

            saveUsersData();
            bootstrap.Modal.getInstance(document.getElementById('editPermissionsModal')).hide();
            loadUsersTable();
            
            const permissionCount = user.permissions.includes('all') ? 'All' : user.permissions.length;
            showAlert('Permissions updated successfully! User now has ' + permissionCount + ' permissions.', 'success');
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values?\n\nThis will:\n- Reset company name to "Reliable OPC"\n- Reset theme to default blue\n- Reset low stock threshold to 20%\n- Keep all user accounts unchanged')) {
                
                document.getElementById('companyName').value = 'Reliable OPC';
                document.getElementById('systemTheme').value = 'default';
                document.getElementById('lowStockThreshold').value = '20';
                
                const settings = {
                    companyName: 'Reliable OPC',
                    theme: 'default',
                    lowStockThreshold: 20
                };
                
                localStorage.setItem('systemSettings', JSON.stringify(settings));
                applyTheme('default');
                
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    headerTitle.innerHTML = '<i class="fas fa-warehouse"></i> Reliable OPC';
                }
                
                updateStockStatuses(20);
                showAlert('Settings reset to defaults successfully!', 'success');
            }
        }

        function exportSystemData() {
            try {
                const systemData = {
                    users: users,
                    settings: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
                    inventoryData: inventoryData,
                    nextId: nextId,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(systemData, null, 2)], { type: 'application/json' });
                fallbackDownload(blob, 'reliable_opc_complete_backup_' + new Date().toISOString().split('T')[0] + '.json');
                
                showAlert('Complete system data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting system data:', error);
                showAlert('Error exporting system data!', 'danger');
            }
        }

        function generateSystemReport() {
            const totalUsers = Object.keys(users).length;
            const adminUsers = Object.values(users).filter(u => u.role === 'Administrator').length;
            const managerUsers = Object.values(users).filter(u => u.role === 'Manager').length;
            const regularUsers = Object.values(users).filter(u => u.role === 'User').length;
            
            const totalItems = inventoryData.length;
            const inStockItems = inventoryData.filter(item => item.status === 'In Stock').length;
            const lowStockItems = inventoryData.filter(item => item.status === 'Low Stock').length;
            const outOfStockItems = inventoryData.filter(item => item.status === 'No Stock' || item.status === 'Pulled Out').length;
            
            const machineCount = inventoryData.filter(item => item.type === 'Machine').length;
            const disposableCount = inventoryData.filter(item => item.type === 'Disposable').length;
            const instrumentCount = inventoryData.filter(item => item.type === 'Instrument').length;
            
            const brainlabCount = inventoryData.filter(item => item.brand === 'Brainlab').length;
            const inomedCount = inventoryData.filter(item => item.brand === 'Inomed').length;
            const medocCount = inventoryData.filter(item => item.brand === 'Medoc').length;
            
            const currentDate = new Date().toLocaleDateString();
            const currentTime = new Date().toLocaleTimeString();
            const settings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
            
            const reportWindow = window.open('', '_blank');
            if (!reportWindow) {
                showAlert('Please allow popups to generate the system report.', 'warning');
                return;
            }
            
            const reportContent = `<!DOCTYPE html>
<html>
<head>
    <title>System Report - ${settings.companyName || 'Reliable OPC'}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
        .section { margin: 30px 0; }
        .section h2 { color: #667eea; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #667eea; }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 5px; }
        .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .info-table th { background-color: #667eea; color: white; }
        .info-table tr:nth-child(even) { background-color: #f9f9f9; }
        .footer { margin-top: 50px; text-align: center; color: #666; font-size: 0.9em; border-top: 1px solid #ddd; padding-top: 20px; }
        @media print { body { margin: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>${settings.companyName || 'Reliable OPC'} - System Report</h1>
        <p>Generated on ${currentDate} at ${currentTime}</p>
        <p>Report generated by: ${currentUser.name} (${currentUser.role})</p>
    </div>
    
    <div class="section">
        <h2>📊 System Overview</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${totalUsers}</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${totalItems}</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${Math.round((inStockItems / totalItems) * 100) || 0}%</div>
                <div class="stat-label">Items In Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${settings.lowStockThreshold || 20}%</div>
                <div class="stat-label">Low Stock Threshold</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>👥 User Management Summary</h2>
        <table class="info-table">
            <tr><th>Role</th><th>Count</th><th>Percentage</th></tr>
            <tr><td>Administrator</td><td>${adminUsers}</td><td>${Math.round((adminUsers / totalUsers) * 100)}%</td></tr>
            <tr><td>Manager</td><td>${managerUsers}</td><td>${Math.round((managerUsers / totalUsers) * 100)}%</td></tr>
            <tr><td>User</td><td>${regularUsers}</td><td>${Math.round((regularUsers / totalUsers) * 100)}%</td></tr>
        </table>
    </div>
    
    <div class="section">
        <h2>📦 Inventory Summary</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${inStockItems}</div>
                <div class="stat-label">In Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${lowStockItems}</div>
                <div class="stat-label">Low Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${outOfStockItems}</div>
                <div class="stat-label">Out of Stock</div>
            </div>
        </div>
        
        <h3>By Category</h3>
        <table class="info-table">
            <tr><th>Type</th><th>Count</th><th>Percentage</th></tr>
            <tr><td>Machines</td><td>${machineCount}</td><td>${Math.round((machineCount / totalItems) * 100) || 0}%</td></tr>
            <tr><td>Disposables</td><td>${disposableCount}</td><td>${Math.round((disposableCount / totalItems) * 100) || 0}%</td></tr>
            <tr><td>Instruments</td><td>${instrumentCount}</td><td>${Math.round((instrumentCount / totalItems) * 100) || 0}%</td></tr>
        </table>
        
        <h3>By Brand</h3>
        <table class="info-table">
            <tr><th>Brand</th><th>Count</th><th>Percentage</th></tr>
            <tr><td>Brainlab</td><td>${brainlabCount}</td><td>${Math.round((brainlabCount / totalItems) * 100) || 0}%</td></tr>
            <tr><td>Inomed</td><td>${inomedCount}</td><td>${Math.round((inomedCount / totalItems) * 100) || 0}%</td></tr>
            <tr><td>Medoc</td><td>${medocCount}</td><td>${Math.round((medocCount / totalItems) * 100) || 0}%</td></tr>
        </table>
    </div>
    
    <div class="section">
        <h2>⚙️ System Configuration</h2>
        <table class="info-table">
            <tr><th>Setting</th><th>Value</th></tr>
            <tr><td>Company Name</td><td>${settings.companyName || 'Reliable OPC'}</td></tr>
            <tr><td>System Theme</td><td>${settings.theme || 'Default'}</td></tr>
            <tr><td>Low Stock Threshold</td><td>${settings.lowStockThreshold || 20}%</td></tr>
            <tr><td>Total Data Size</td><td>${Math.round(JSON.stringify({users, inventoryData}).length / 1024)} KB</td></tr>
        </table>
    </div>
    
    <div class="footer">
        <p>This report was generated by ${settings.companyName || 'Reliable OPC'} Inventory Management System</p>
        <p>For technical support, contact your system administrator</p>
    </div>
    
    <script>
        setTimeout(function() { window.print(); }, 1000);
        window.addEventListener('afterprint', function() {
            setTimeout(function() { window.close(); }, 2000);
        });
    <\/script>
</body>
</html>`;
            
            reportWindow.document.write(reportContent);
            reportWindow.document.close();
            
            showAlert('System report generated! Use Ctrl+P to save as PDF.', 'info');
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            setupLoginForm();
            loadUsersData();
            loadSystemSettings();
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                    loadAllData();
                } catch (error) {
                    console.error('Error loading saved user:', error);
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        });

            window.addEventListener("DOMContentLoaded", () => {
      loadDataFromCloud();
    });
    
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f143a5935d8d02',t:'MTc1NTE4MzAyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
